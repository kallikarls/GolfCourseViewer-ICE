<!DOCTYPE html>
<html lang="is">
<head>
  <meta charset="UTF-8" />
  <title>Golf Course Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html, body {
      height: 100%;
      margin: 0;
    }
    #map {
      height: 100%;
      width: 100%;
    }
    #sidebar {
      position: absolute;
      top: 0;
      right: 0;
      width: 360px;
      height: 100%;
      background-color: white;
      box-shadow: -2px 0 5px rgba(0, 0, 0, 0.2);
      z-index: 1000;
      display: flex;
      flex-direction: column;
      transition: right 0.3s ease;
    }
    #sidebar.collapsed {
      right: -360px;
    }
    #toggleSidebarBtn {
      position: absolute;
      top: 10px;
      right: 370px;
      z-index: 1100;
    }
    #toggleSidebarBtn.collapsed {
      right: 10px;
    }
    #searchSection, #layerToggleSection, #infoPanelSection {
      padding: 1rem;
      overflow-y: auto;
    }
    #searchSection {
      max-height: 40%;
      border-bottom: 1px solid #ddd;
    }
    #layerToggleSection {
      max-height: 30%;
      border-bottom: 1px solid #ddd;
    }
    #infoPanelSection {
      flex-grow: 1;
      overflow-y: auto;
    }
    thead th {
      position: sticky;
      top: 0;
      background: white;
    }
    .layer-entry {
      padding: 4px 0;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- Toggle Sidebar Button -->
  <button id="toggleSidebarBtn" class="btn btn-sm btn-outline-secondary">Hide</button>

  <!-- Sidebar Panel -->
  <div id="sidebar">
    <!-- Course Selection (Top) -->
    <div id="searchSection">
      <input
        id="searchInput"
        type="text"
        class="form-control mb-3"
        placeholder="Leitaðu að velli eða klúbbi..."
      />
      <table class="table table-bordered table-hover mb-0" id="courseTable">
        <thead class="table-light">
          <tr>
            <th>Course</th>
            <th>Club</th>
          </tr>
        </thead>
        <tbody id="courseTableBody"></tbody>
      </table>
    </div>

    <!-- Layer Toggles (Middle) -->
    <div id="layerToggleSection">
      <h6>Toggle Layers</h6>
      <div id="layerToggles" class="form-check"></div>
    </div>

    <!-- Layer Info Summary (Bottom) -->
    <div id="infoPanelSection">
      <h6>Layer Areas</h6>
      <div id="featureInfo" class="small text-muted">Veldu völl...</div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    let map = L.map("map").setView([64.9, -18.0], 6);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
    let geoJsonLayer = null;
    let courseList = [];
    let currentFeatureGroup = null;
    let layerGroups = {};

    // Load and render course list
    fetch("courseIndex.json")
      .then(res => res.json())
      .then(data => {
        courseList = Object.entries(data).map(([courseName, clubName]) => ({
          courseName,
          clubName
        }));
        renderTable(courseList);
      });

    function renderTable(data) {
      const tbody = document.getElementById("courseTableBody");
      tbody.innerHTML = "";
      data.forEach(course => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${course.courseName}</td><td>${course.clubName}</td>`;
        const fileName = `courses/${course.courseName}.geojson`;
        tr.onclick = () => loadGeoJson(fileName);
        tbody.appendChild(tr);
      });
    }

    function loadGeoJson(path) {
      if (geoJsonLayer) geoJsonLayer.remove();
      if (currentFeatureGroup) currentFeatureGroup.clearLayers();
      document.getElementById("layerToggles").innerHTML = "";
      document.getElementById("featureInfo").innerText = "Veldu völl...";

      fetch(path)
        .then(res => res.json())
        .then(data => {
          currentFeatureGroup = L.featureGroup().addTo(map);
          layerGroups = {};
          const areaSummary = {};

          data.features.forEach(feature => {
            const layerType = feature.properties?.layer || "Other";
            const area = parseFloat(feature.properties?.AreaSqMeters || 0);
            if (!areaSummary[layerType]) areaSummary[layerType] = 0;
            areaSummary[layerType] += area;

            const layer = L.geoJSON(feature);
            if (!layerGroups[layerType]) {
              layerGroups[layerType] = L.layerGroup().addTo(map);
              createLayerToggle(layerType);
            }
            layer.addTo(layerGroups[layerType]);
            layer.addTo(currentFeatureGroup);
          });

          renderAreaSummary(areaSummary);

          if (currentFeatureGroup.getBounds().isValid()) {
            map.fitBounds(currentFeatureGroup.getBounds());
          }
        });
    }

    function createLayerToggle(layerType) {
      const container = document.getElementById("layerToggles");
      const id = `layerToggle_${layerType}`;

      const div = document.createElement("div");
      div.className = "form-check";

      const checkbox = document.createElement("input");
      checkbox.className = "form-check-input";
      checkbox.type = "checkbox";
      checkbox.id = id;
      checkbox.checked = true;
      checkbox.onchange = () => {
        const group = layerGroups[layerType];
        if (group) {
          if (checkbox.checked) {
            group.addTo(map);
          } else {
            group.remove();
          }
        }
      };

      const label = document.createElement("label");
      label.className = "form-check-label";
      label.htmlFor = id;
      label.textContent = layerType;

      div.appendChild(checkbox);
      div.appendChild(label);
      container.appendChild(div);
    }

    function renderAreaSummary(areaSummary) {
      const infoPanel = document.getElementById("featureInfo");
      infoPanel.innerHTML = Object.entries(areaSummary)
        .map(([layer, area]) =>
          `<div class="layer-entry">${layer}: ${area.toLocaleString(undefined, { maximumFractionDigits: 1 })} m²</div>`
        )
        .join("");
    }

    // Filter table
    document.getElementById("searchInput").addEventListener("input", () => {
      const filter = document.getElementById("searchInput").value.toLowerCase();
      const filtered = courseList.filter(c =>
        String(c.courseName || "").toLowerCase().includes(filter) ||
        String(c.clubName || "").toLowerCase().includes(filter)
      );
      renderTable(filtered);
    });

    // Sidebar toggle
    const sidebar = document.getElementById("sidebar");
    const toggleBtn = document.getElementById("toggleSidebarBtn");

    toggleBtn.addEventListener("click", () => {
      sidebar.classList.toggle("collapsed");
      toggleBtn.classList.toggle("collapsed");
      toggleBtn.textContent = sidebar.classList.contains("collapsed") ? "Show" : "Hide";
    });
  </script>
</body>
</html>
