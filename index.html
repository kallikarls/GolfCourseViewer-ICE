<!DOCTYPE html>
<html lang="is">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Golf Course Viewer</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
    }
    #map {
      height: 100vh;
      width: 100%;
    }
    .course-panel {
      position: absolute;
      top: 1rem;
      left: 1rem;
      width: 320px;
      max-height: 60px;
      overflow: hidden;
      background: white;
      padding: 1rem;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.15);
      z-index: 1000;
      transition: max-height 0.3s ease;
    }
    .course-panel.expanded {
      max-height: 80vh;
      overflow-y: auto;
    }
    .side-panel {
      position: absolute;
      top: 1rem;
      right: 1rem;
      width: 360px;
      max-height: calc(100vh - 2rem);
      overflow-y: auto;
      background: #fff;
      padding: 1rem;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.15);
      z-index: 1000;
    }
    .side-panel > div {
      margin-bottom: 2rem;
    }
    .expand-btn {
      position: absolute;
      top: 5px;
      right: 10px;
      background: none;
      border: none;
      font-size: 1.2rem;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="course-panel" id="coursePanel">
    <button class="expand-btn" id="toggleBtn" onclick="toggleCoursePanel()">▼</button>
    <input id="searchInput" type="text" class="form-control mb-2" placeholder="Leitaðu að velli eða klúbbi..." />
    <table class="table table-sm table-bordered">
      <thead class="table-light">
        <tr><th>Course</th><th>Club</th></tr>
      </thead>
      <tbody id="courseTableBody"></tbody>
    </table>
  </div>

  <div class="side-panel">
    <div>
      <strong>Toggle Layers</strong>
      <div id="layerToggles"></div>
    </div>
    <div>
      <strong>Layer Areas</strong>
      <div id="layerAreas"></div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const leafletMap = L.map('map').setView([64.96, -18.65], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(leafletMap);

    const courseLayers = {}, courseAreas = {}, courseInfo = [];

    fetch('FeatureCollection.geojson')
      .then(res => res.json())
      .then(data => {
        const allFeatures = L.geoJSON(data, {
          onEachFeature: (feature, layer) => {
            const course = feature.properties.course || 'unknown';
            const layerName = feature.properties.layer || 'unknown';
            const area = parseFloat(feature.properties.AreaSqMeters || 0);
            const courseName = feature.properties.courseName || course;
            const clubName = feature.properties.clubName || 'Unknown';

            if (!courseLayers[course]) {
              courseLayers[course] = {};
              courseAreas[course] = {};
              courseInfo.push({ course, courseName, clubName });
            }

            if (!courseLayers[course][layerName]) {
              courseLayers[course][layerName] = L.layerGroup();
              courseAreas[course][layerName] = 0;
            }

            courseAreas[course][layerName] += area;
            const sublayer = L.geoJSON(feature);
            sublayer.addTo(courseLayers[course][layerName]);
          }
        });

        populateCourseList();
      });

    function populateCourseList() {
      const tbody = document.getElementById('courseTableBody');
      const input = document.getElementById('searchInput');

      function renderList(filter = '') {
        tbody.innerHTML = '';
        const filtered = courseInfo.filter(c =>
          c.courseName.toLowerCase().includes(filter.toLowerCase()) ||
          c.clubName.toLowerCase().includes(filter.toLowerCase())
        );
        document.getElementById('coursePanel').classList.toggle('expanded', filtered.length > 0);
        document.getElementById('toggleBtn').textContent = filtered.length > 0 ? '▲' : '▼';

        filtered.forEach(c => {
          const row = document.createElement('tr');
          row.innerHTML = `<td>${c.courseName}</td><td>${c.clubName}</td>`;
          row.style.cursor = 'pointer';
          row.onclick = () => updateCourseView(c.course);
          tbody.appendChild(row);
        });
      }

      input.addEventListener('input', () => renderList(input.value));
      renderList();
    }

    function updateCourseView(courseKey) {
      for (const layerMap of Object.values(courseLayers)) {
        for (const group of Object.values(layerMap)) leafletMap.removeLayer(group);
      }

      const toggles = document.getElementById('layerToggles');
      const areas = document.getElementById('layerAreas');
      toggles.innerHTML = '';
      areas.innerHTML = '';

      let bounds = L.latLngBounds();
      for (const [layerName, group] of Object.entries(courseLayers[courseKey])) {
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.checked = true;
        checkbox.className = 'form-check-input me-1';
        checkbox.onchange = () => {
          if (checkbox.checked) group.addTo(leafletMap);
          else leafletMap.removeLayer(group);
          leafletMap.invalidateSize();
        };

        const label = document.createElement('label');
        label.className = 'form-check-label';
        label.textContent = layerName;

        const div = document.createElement('div');
        div.className = 'form-check';
        div.append(checkbox, label);
        toggles.appendChild(div);

        group.addTo(leafletMap);
        group.eachLayer(l => { if (l.getBounds) bounds.extend(l.getBounds()); });

        const areaEntry = document.createElement('div');
        areaEntry.textContent = `${layerName}: ${courseAreas[courseKey][layerName].toLocaleString(undefined, {maximumFractionDigits: 1})} m²`;
        areas.appendChild(areaEntry);
      }

      if (bounds.isValid()) leafletMap.fitBounds(bounds);
    }

    function toggleCoursePanel() {
      const panel = document.getElementById('coursePanel');
      const toggleBtn = document.getElementById('toggleBtn');
      const expanded = panel.classList.toggle('expanded');
      toggleBtn.textContent = expanded ? '▲' : '▼';
    }
  </script>
</body>
</html>
